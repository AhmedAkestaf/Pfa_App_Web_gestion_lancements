{% extends 'base/base.html' %}
{% load static %}

{% block title %}Planning des Lancements{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'lancements:list' %}">Lancements</a></li>
    <li class="breadcrumb-item active">Planning</li>
{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css" rel="stylesheet">
<style>
.planning-header {
    background: linear-gradient(135deg, #17a2b8, #007bff);
    color: white;
    padding: 2rem;
    border-radius: 15px;
    margin-bottom: 2rem;
}

.calendar-card {
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border: none;
    border-radius: 15px;
    min-height: 600px;
}

.calendar-controls {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1rem;
}

.view-toggle button {
    border: 1px solid #dee2e6;
    background: white;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    margin: 0 0.25rem;
    cursor: pointer;
    transition: all 0.2s;
}

.view-toggle button.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.month-navigation {
    display: flex;
    align-items: center;
    gap: 1rem;
}

/* Styles FullCalendar personnalis√©s */
.fc-event {
    border-radius: 4px;
    border: none !important;
    padding: 2px 4px;
    font-size: 0.75rem;
    cursor: pointer;
}

.fc-event.lancement-planifie {
    background-color: #6c757d !important;
    color: white !important;
}

.fc-event.lancement-en_cours {
    background-color: #ffc107 !important;
    color: #212529 !important;
}

.fc-event.lancement-termine {
    background-color: #28a745 !important;
    color: white !important;
}

.fc-event.lancement-en_attente {
    background-color: #17a2b8 !important;
    color: white !important;
}

.legend-item {
    display: flex;
    align-items: center;
    margin: 0.5rem 0;
}

.legend-color {
    width: 20px;
    height: 15px;
    border-radius: 3px;
    margin-right: 0.5rem;
}

.stats-card {
    border-left: 4px solid #17a2b8;
}

/* CORRECTION: Styles pour garantir l'affichage correct */
#calendar {
    min-height: 500px;
    width: 100%;
    opacity: 0;
    transition: opacity 0.3s ease;
}

#calendar.calendar-ready {
    opacity: 1;
}

.fc {
    min-height: 500px;
    width: 100%;
}

.loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 200px;
}

/* Emp√™cher le freeze lors des transitions */
.fc-view-harness {
    overflow: hidden;
}

.fc-daygrid-event-harness {
    position: relative;
}

/* Debug info styles */
.debug-info {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 10px;
    margin-bottom: 15px;
    font-size: 0.875rem;
}
</style>
{% endblock %}

{% block content %}
<!-- Donn√©es JSON pour JavaScript -->
<script type="application/json" id="initial-lancements-data">
{
  "lancements": {{ lancements_json|safe }},
  "api_url": "{% url 'lancements:api_data' %}",
  "current_year": {{ year|default:"new Date().getFullYear()" }},
  "current_month": {{ month|default:"new Date().getMonth() + 1" }},
  "debug_enabled": true
}
</script>

<!-- Informations de debug -->
{% if debug_info %}
<div class="debug-info">
    <strong>üîç Debug Planning:</strong>
    <span class="badge bg-primary">{{ debug_info.total_lancements_db }} total en DB</span>
    <span class="badge bg-info">{{ debug_info.lancements_month }} ce mois</span>
    <span class="badge bg-success">{{ debug_info.lancements_json_length }} caract√®res JSON</span>
    {% if debug_info.lancements_json_length <= 2 %}
        <span class="badge bg-warning">‚ö†Ô∏è JSON vide ou invalide d√©tect√©</span>
    {% endif %}
    <br><small>P√©riode: {{ debug_info.date_range }}</small>
    <br><small>URL API: {% url 'lancements:api_data' %}</small>
</div>
{% endif %}

<div class="container-fluid">
    <!-- En-t√™te -->
    <div class="planning-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="fas fa-calendar-alt me-3"></i>
                    Planning des Lancements
                </h1>
                <p class="mb-0">Vue d'ensemble des lancements par date de lancement pr√©vue</p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="view-toggle">
                    <button type="button" class="btn-view active" data-view="dayGridMonth">
                        <i class="fas fa-calendar"></i> Mois
                    </button>
                    <button type="button" class="btn-view" data-view="timeGridWeek">
                        <i class="fas fa-calendar-week"></i> Semaine
                    </button>
                    <button type="button" class="btn-view" data-view="timeGridDay">
                        <i class="fas fa-calendar-day"></i> Jour
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-9">
            <!-- Contr√¥les du calendrier -->
            <div class="calendar-controls">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="month-navigation">
                            <button class="btn btn-outline-primary" id="prevMonth">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h4 class="mb-0" id="currentMonth">{{ current_month|date:"F Y" }}</h4>
                            <button class="btn btn-outline-primary" id="nextMonth">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <div class="btn-group">
                            <button class="btn btn-outline-info" id="todayBtn">
                                <i class="fas fa-crosshairs"></i> Aujourd'hui
                            </button>
                            {% if can_create %}
                            <a href="{% url 'lancements:create' %}" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Nouveau Lancement
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendrier principal -->
            <div class="card calendar-card">
                <div class="card-body p-2">
                    <div id="calendar-loading" class="loading-spinner">
                        <div>
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                            <p class="mt-2 text-center">Chargement du planning...</p>
                        </div>
                    </div>
                    <div id="calendar"></div>
                    <div id="calendar-error" class="alert alert-danger" style="display: none;">
                        <h5><i class="fas fa-exclamation-triangle"></i> Erreur de chargement</h5>
                        <p id="error-message">Une erreur s'est produite lors du chargement du calendrier.</p>
                        <button class="btn btn-outline-danger" onclick="location.reload()">
                            <i class="fas fa-sync"></i> Recharger la page
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar droite -->
        <div class="col-lg-3">
            <!-- L√©gende -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>L√©gende
                    </h5>
                </div>
                <div class="card-body">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #6c757d;"></div>
                        <span>Planifi√©</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ffc107;"></div>
                        <span>En cours</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #28a745;"></div>
                        <span>Termin√©</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #17a2b8;"></div>
                        <span>En attente</span>
                    </div>
                </div>
            </div>

            <!-- Statistiques rapides -->
            <div class="card stats-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Statistiques du mois
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <h4 class="text-primary">{{ stats.total_month|default:0 }}</h4>
                            <small class="text-muted">Total</small>
                        </div>
                        <div class="col-6 mb-3">
                            <h4 class="text-warning">{{ stats.en_cours_month|default:0 }}</h4>
                            <small class="text-muted">En cours</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success">{{ stats.termines_month|default:0 }}</h4>
                            <small class="text-muted">Termin√©s</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-info">{{ stats.planifies_month|default:0 }}</h4>
                            <small class="text-muted">Planifi√©s</small>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="text-center">
                        <strong class="text-info">{{ stats.poids_total_month|default:0 }} kg</strong>
                        <br><small class="text-muted">Poids total du mois</small>
                    </div>
                </div>
            </div>

            <!-- Filtres -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Filtres
                    </h5>
                </div>
                <div class="card-body">
                    <form id="filterForm">
                        <div class="mb-3">
                            <label class="form-label">Atelier</label>
                            <select class="form-select form-select-sm" id="filterAtelier">
                                <option value="">Tous les ateliers</option>
                                {% for atelier in ateliers %}
                                    <option value="{{ atelier.id }}">{{ atelier.nom_atelier }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Statut</label>
                            <select class="form-select form-select-sm" id="filterStatut">
                                <option value="">Tous les statuts</option>
                                <option value="planifie">Planifi√©</option>
                                <option value="en_cours">En cours</option>
                                <option value="termine">Termin√©</option>
                                <option value="en_attente">En attente</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Collaborateur</label>
                            <select class="form-select form-select-sm" id="filterCollaborateur">
                                <option value="">Tous</option>
                                {% for collaborateur in collaborateurs %}
                                    <option value="{{ collaborateur.id }}">{{ collaborateur.get_full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <button type="button" class="btn btn-outline-primary btn-sm w-100 mb-2" id="applyFilters">
                            <i class="fas fa-search"></i> Appliquer
                        </button>
                        
                        <button type="button" class="btn btn-outline-secondary btn-sm w-100" id="clearFilters">
                            <i class="fas fa-times"></i> Effacer
                        </button>
                    </form>
                </div>
            </div>

            <!-- Actions rapides -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>Actions Rapides
                    </h5>
                </div>
                <div class="card-body d-grid gap-2">
                    <a href="{% url 'lancements:list' %}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-list"></i> Liste des lancements
                    </a>
                    
                    {% if can_create %}
                    <a href="{% url 'lancements:create' %}" class="btn btn-outline-success btn-sm">
                        <i class="fas fa-plus"></i> Nouveau lancement
                    </a>
                    {% endif %}
                    
                    <button class="btn btn-outline-info btn-sm" onclick="window.print()">
                        <i class="fas fa-print"></i> Imprimer planning
                    </button>
                    
                    <button class="btn btn-outline-warning btn-sm" id="refreshData">
                        <i class="fas fa-sync"></i> Actualiser
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour les d√©tails du lancement -->
<div class="modal fade" id="lancementModal" tabindex="-1" aria-labelledby="lancementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="lancementModalLabel">
                    <i class="fas fa-rocket me-2"></i>
                    <span id="modalTitle">D√©tails du Lancement</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalContent">
                <div class="text-center p-3">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <a href="#" class="btn btn-primary" id="viewDetailsBtn">Voir tous les d√©tails</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/locales/fr.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== Initialisation du planning SOLUTION COMPL√àTE ===');
    
    // Variables globales
    let CONFIG = null;
    let calendar = null;
    let allEvents = [];
    let isLoading = false;
    let initializationAttempts = 0;
    const MAX_INIT_ATTEMPTS = 3;
    
    // ========================================================================================
    // SECTION 1: CONFIGURATION ET CHARGEMENT DES DONN√âES
    // ========================================================================================
    
    function loadConfig() {
        try {
            const configElement = document.getElementById('initial-lancements-data');
            if (configElement && configElement.textContent) {
                CONFIG = JSON.parse(configElement.textContent);
                console.log('‚úÖ Configuration charg√©e:', CONFIG);
                return true;
            }
        } catch (e) {
            console.error('‚ùå Erreur parsing configuration:', e);
        }
        
        // Configuration par d√©faut
        CONFIG = {
            lancements: [],
            api_url: '/lancements/api/data/',
            current_year: new Date().getFullYear(),
            current_month: new Date().getMonth() + 1,
            debug_enabled: true
        };
        return false;
    }
    
    async function loadAllLancements(startDate = null, endDate = null) {
        if (isLoading) {
            console.log('üì° Chargement d√©j√† en cours, abandon...');
            return [];
        }
        
        isLoading = true;
        console.log('üì° Chargement des lancements...', { startDate, endDate });
        
        try {
            const params = new URLSearchParams();
            
            if (!startDate && !endDate) {
                const now = new Date();
                const startOfYear = new Date(now.getFullYear(), 0, 1);
                const endOfYear = new Date(now.getFullYear() + 1, 11, 31);
                
                startDate = startOfYear.toISOString().split('T')[0];
                endDate = endOfYear.toISOString().split('T')[0];
                
                console.log('üìÖ Chargement de toute l\'ann√©e:', startDate, '√†', endDate);
            }
            
            if (startDate) params.append('start', startDate);
            if (endDate) params.append('end', endDate);
            
            const url = `${CONFIG.api_url}?${params.toString()}`;
            console.log('üåê URL API compl√®te:', url);
            
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'Cache-Control': 'no-cache'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('üìä Donn√©es re√ßues:', data);
            
            if (data.success && Array.isArray(data.events)) {
                console.log('‚úÖ Lancements charg√©s:', data.events.length);
                return data.events;
            } else if (data.error) {
                console.error('‚ùå Erreur API:', data.error);
                return [];
            } else {
                console.warn('‚ö†Ô∏è Format de r√©ponse inattendu:', data);
                return [];
            }
            
        } catch (error) {
            console.error('‚ùå Erreur lors du chargement:', error);
            return getFallbackData();
        } finally {
            isLoading = false;
        }
    }
    
    function getFallbackData() {
        console.log('üîÑ Utilisation des donn√©es fallback...');
        
        if (CONFIG.lancements && Array.isArray(CONFIG.lancements)) {
            console.log('üìã Donn√©es fallback trouv√©es:', CONFIG.lancements.length);
            return CONFIG.lancements;
        }
        
        console.log('üìã Aucune donn√©e fallback disponible');
        return [];
    }
    
    function transformToCalendarEvents(lancements) {
        if (!Array.isArray(lancements)) {
            console.error('‚ùå lancements n\'est pas un tableau:', typeof lancements);
            return [];
        }
        
        console.log('üîÑ Transformation de', lancements.length, 'lancements');
        
        const events = lancements.map((lancement, index) => {
            try {
                if (!lancement.date_lancement) {
                    console.warn('‚ö†Ô∏è Lancement sans date:', lancement);
                    return null;
                }
                
                return {
                    id: (lancement.id || `temp-${index}`).toString(),
                    title: lancement.num_lanc || `L-${lancement.id || index}`,
                    start: lancement.date_lancement,
                    className: `lancement-${lancement.statut || 'planifie'}`,
                    extendedProps: {
                        num_lanc: lancement.num_lanc || `L-${lancement.id || index}`,
                        affaire_code: lancement.affaire_code || 'N/A',
                        client: lancement.client || 'N/A',
                        atelier_nom: lancement.atelier_nom || 'Aucun atelier',
                        atelier_id: lancement.atelier_id,
                        collaborateur_nom: lancement.collaborateur_nom || 'Aucun collaborateur',
                        collaborateur_id: lancement.collaborateur_id,
                        statut: lancement.statut || 'planifie',
                        statut_display: lancement.statut_display || 'Planifi√©',
                        poids_total: parseFloat(lancement.poids_total || 0),
                        sous_livrable: lancement.sous_livrable || 'Pas de description',
                        date_reception: lancement.date_reception || '',
                        observations: lancement.observations || ''
                    }
                };
            } catch (e) {
                console.error('‚ùå Erreur transformation:', e, lancement);
                return null;
            }
        }).filter(event => event !== null);
        
        console.log('‚úÖ √âv√©nements transform√©s:', events.length);
        return events;
    }
    
    // ========================================================================================
    // SECTION 2: INITIALISATION DU CALENDRIER - SOLUTION PRINCIPALE
    // ========================================================================================
    
    function initializeCalendar(events = []) {
        const calendarEl = document.getElementById('calendar');
        
        if (!calendarEl) {
            console.error('‚ùå √âl√©ment #calendar non trouv√©');
            return false;
        }
        
        console.log('üóìÔ∏è Initialisation calendrier avec', events.length, '√©v√©nements');
        
        try {
            // D√©truire l'ancien calendrier si existant
            if (calendar) {
                calendar.destroy();
                calendar = null;
            }
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'fr',
                height: 'auto',
                headerToolbar: false,
                events: events,
                
                // Configuration d'affichage
                eventDisplay: 'block',
                dayMaxEvents: 3,
                moreLinkClick: 'popover',
                
                // SOLUTION PRINCIPALE: Callbacks pour forcer le bon rendu
                loading: function(isLoading) {
                    console.log('üìä Calendar loading state:', isLoading);
                },
                
                viewDidMount: function(view) {
                    console.log('üìÖ Vue mont√©e:', view.type);
                    // SOLUTION 1: Forcer le recalcul des dimensions
                    requestAnimationFrame(() => {
                        if (calendar) {
                            calendar.updateSize();
                        }
                    });
                },
                
                eventDidMount: function(info) {
                    const props = info.event.extendedProps;
                    info.el.title = [
                        `${props.num_lanc}`,
                        `Affaire: ${props.affaire_code}`,
                        `Client: ${props.client}`,
                        `Atelier: ${props.atelier_nom}`,
                        `Statut: ${props.statut_display}`,
                        `Poids: ${props.poids_total} kg`
                    ].join('\n');
                },
                
                // Gestion des √©v√©nements
                eventClick: function(info) {
                    console.log('üëÜ Clic sur √©v√©nement:', info.event.title);
                    showLancementDetails(info.event);
                },
                
                // Rendu personnalis√© des √©v√©nements
                eventContent: function(arg) {
                    const props = arg.event.extendedProps;
                    const colors = {
                        'planifie': { bg: '#6c757d', text: 'white' },
                        'en_cours': { bg: '#ffc107', text: '#212529' },
                        'termine': { bg: '#28a745', text: 'white' },
                        'en_attente': { bg: '#17a2b8', text: 'white' }
                    };
                    
                    const color = colors[props.statut] || colors['planifie'];
                    
                    return {
                        html: `<div style="
                            font-size: 0.75rem; 
                            padding: 2px 4px; 
                            background-color: ${color.bg}; 
                            color: ${color.text}; 
                            border-radius: 3px; 
                            overflow: hidden;
                            cursor: pointer;
                        ">
                            <div style="font-weight: bold;">${arg.event.title}</div>
                            <div style="font-size: 0.6rem; opacity: 0.9;">
                                ${(props.atelier_nom || '').substring(0, 15)}
                            </div>
                        </div>`
                    };
                },
                
                // Navigation
                datesSet: function(dateInfo) {
                    updateMonthDisplay();
                    console.log('üìÖ P√©riode affich√©e:', dateInfo.startStr, '√†', dateInfo.endStr);
                    
                    // SOLUTION 2: Forcer le recalcul apr√®s changement de date
                    setTimeout(() => {
                        if (calendar) {
                            calendar.updateSize();
                        }
                    }, 50);
                }
            });
            
            // SOLUTION PRINCIPALE: S√©quence de rendu optimis√©e
            console.log('üéØ D√©but du rendu du calendrier...');
            
            // √âtape 1: Rendu initial
            calendar.render();
            
            // √âtape 2: Attendre que le DOM soit stabilis√©
            requestAnimationFrame(() => {
                console.log('üîÑ Premier requestAnimationFrame');
                
                // √âtape 3: Forcer l'affichage du calendrier
                showCalendar();
                
                // √âtape 4: Deuxi√®me passage pour stabiliser
                requestAnimationFrame(() => {
                    console.log('üîÑ Deuxi√®me requestAnimationFrame');
                    
                    if (calendar) {
                        // Forcer le recalcul des dimensions
                        calendar.updateSize();
                        
                        // Marquer le calendrier comme pr√™t
                        calendarEl.classList.add('calendar-ready');
                        
                        console.log('‚úÖ Calendrier compl√®tement initialis√©');
                        
                        // SOLUTION 3: V√©rification finale apr√®s un d√©lai
                        setTimeout(() => {
                            if (calendar) {
                                calendar.updateSize();
                                console.log('üîß V√©rification finale effectu√©e');
                            }
                        }, 200);
                    }
                });
            });
            
            // Sauvegarder pour les filtres
            allEvents = events;
            return true;
            
        } catch (e) {
            console.error('‚ùå Erreur initialisation calendrier:', e);
            showError('Erreur lors de l\'initialisation du calendrier: ' + e.message);
            return false;
        }
    }
    
    // ========================================================================================
    // SECTION 3: FONCTIONS D'AFFICHAGE - SOLUTION AM√âLIOR√âE
    // ========================================================================================
    
    function showCalendar() {
        const loading = document.getElementById('calendar-loading');
        const calendarEl = document.getElementById('calendar');
        const error = document.getElementById('calendar-error');
        
        console.log('üé≠ Affichage du calendrier...');
        
        // Masquer loading et erreur
        if (loading) {
            loading.style.display = 'none';
            console.log('‚úÖ Loading masqu√©');
        }
        if (error) {
            error.style.display = 'none';
            console.log('‚úÖ Erreur masqu√©e');
        }
        
        // Afficher le calendrier
        if (calendarEl) {
            calendarEl.style.display = 'block';
            console.log('‚úÖ Calendrier affich√©');
            
            // SOLUTION: Forcer le reflow du DOM
            calendarEl.offsetHeight;
            
            // D√©clencher un √©v√©nement de redimensionnement
            setTimeout(() => {
                window.dispatchEvent(new Event('resize'));
                console.log('üîÑ √âv√©nement resize d√©clench√©');
            }, 10);
        }
    }
    
    function showError(message) {
        console.error('üí• Erreur:', message);
        const loading = document.getElementById('calendar-loading');
        const error = document.getElementById('calendar-error');
        const errorMsg = document.getElementById('error-message');
        const calendarEl = document.getElementById('calendar');
        
        if (loading) loading.style.display = 'none';
        if (calendarEl) calendarEl.style.display = 'none';
        if (error) error.style.display = 'block';
        if (errorMsg) errorMsg.textContent = message;
    }
    
    function updateMonthDisplay() {
        const monthTitle = document.getElementById('currentMonth');
        if (!monthTitle || !calendar) return;
        
        const currentDate = calendar.getDate();
        const monthNames = [
            'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
            'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
        ];
        monthTitle.textContent = monthNames[currentDate.getMonth()] + ' ' + currentDate.getFullYear();
    }
    
    // ========================================================================================
    // SECTION 4: CONTR√îLES ET INTERACTIONS
    // ========================================================================================
    
    function setupControls() {
        console.log('üéÆ Configuration des contr√¥les...');
        
        // Navigation mensuelle
        const prevBtn = document.getElementById('prevMonth');
        const nextBtn = document.getElementById('nextMonth');
        const todayBtn = document.getElementById('todayBtn');
        
        if (prevBtn) {
            prevBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (calendar) {
                    calendar.prev();
                    // Forcer le recalcul apr√®s navigation
                    setTimeout(() => calendar.updateSize(), 50);
                }
            });
        }
        
        if (nextBtn) {
            nextBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (calendar) {
                    calendar.next();
                    // Forcer le recalcul apr√®s navigation
                    setTimeout(() => calendar.updateSize(), 50);
                }
            });
        }
        
        if (todayBtn) {
            todayBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (calendar) {
                    calendar.today();
                    // Forcer le recalcul apr√®s navigation
                    setTimeout(() => calendar.updateSize(), 50);
                }
            });
        }
        
        // Actualisation
        const refreshBtn = document.getElementById('refreshData');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', (e) => {
                e.preventDefault();
                location.reload();
            });
        }
        
        // Changement de vue
        document.querySelectorAll('.btn-view').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const view = btn.dataset.view;
                
                document.querySelectorAll('.btn-view').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                if (calendar) {
                    calendar.changeView(view);
                    // Forcer le recalcul apr√®s changement de vue
                    setTimeout(() => calendar.updateSize(), 100);
                }
            });
        });
        
        // Filtres
        const applyBtn = document.getElementById('applyFilters');
        const clearBtn = document.getElementById('clearFilters');
        
        if (applyBtn) {
            applyBtn.addEventListener('click', applyFilters);
        }
        
        if (clearBtn) {
            clearBtn.addEventListener('click', clearFilters);
        }
        
        console.log('‚úÖ Contr√¥les configur√©s');
    }
    
    // ========================================================================================
    // SECTION 5: SYST√àME DE FILTRES
    // ========================================================================================
    
    function applyFilters() {
        const atelierId = document.getElementById('filterAtelier')?.value || '';
        const statut = document.getElementById('filterStatut')?.value || '';
        const collaborateurId = document.getElementById('filterCollaborateur')?.value || '';
        
        console.log('üîç Application des filtres:', { atelierId, statut, collaborateurId });
        
        const filteredEvents = allEvents.filter(event => {
            const props = event.extendedProps;
            
            if (atelierId && props.atelier_id != atelierId) return false;
            if (statut && props.statut !== statut) return false;
            if (collaborateurId && props.collaborateur_id != collaborateurId) return false;
            
            return true;
        });
        
        console.log('üìä √âv√©nements filtr√©s:', filteredEvents.length, '/', allEvents.length);
        
        if (calendar) {
            calendar.removeAllEvents();
            filteredEvents.forEach(event => calendar.addEvent(event));
            
            // SOLUTION: Forcer le rendu apr√®s application des filtres
            setTimeout(() => {
                calendar.updateSize();
                calendar.render();
            }, 50);
        }
    }
    
    function clearFilters() {
        const form = document.getElementById('filterForm');
        if (form) {
            form.reset();
        }
        
        if (calendar && allEvents.length > 0) {
            calendar.removeAllEvents();
            allEvents.forEach(event => calendar.addEvent(event));
            
            // SOLUTION: Forcer le rendu apr√®s suppression des filtres
            setTimeout(() => {
                calendar.updateSize();
                calendar.render();
            }, 50);
        }
    }
    
    // ========================================================================================
    // SECTION 6: MODAL DES D√âTAILS
    // ========================================================================================
    
    function showLancementDetails(event) {
        const props = event.extendedProps;
        console.log('üìã Affichage d√©tails:', props.num_lanc);
        
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const viewDetailsBtn = document.getElementById('viewDetailsBtn');
        
        if (modalTitle) modalTitle.textContent = `Lancement ${props.num_lanc}`;
        
        if (viewDetailsBtn && event.id) {
            viewDetailsBtn.href = `/lancements/${event.id}/`;
        }
        
        if (modalContent) {
            modalContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-briefcase me-2"></i>Affaire</h6>
                        <p><strong>${props.affaire_code}</strong><br>
                        <small class="text-muted">${props.client}</small></p>
                        
                        <h6><i class="fas fa-industry me-2"></i>Atelier</h6>
                        <p>${props.atelier_nom}</p>
                        
                        <h6><i class="fas fa-user me-2"></i>Collaborateur</h6>
                        <p>${props.collaborateur_nom}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-flag me-2"></i>Statut</h6>
                        <p><span class="badge bg-${getStatusColor(props.statut)}">${props.statut_display}</span></p>
                        
                        <h6><i class="fas fa-weight me-2"></i>Poids Total</h6>
                        <p><strong>${props.poids_total} kg</strong></p>
                        
                        <h6><i class="fas fa-calendar me-2"></i>Date de lancement</h6>
                        <p>${formatDate(event.start)}</p>
                        
                        ${props.date_reception ? `
                        <h6><i class="fas fa-calendar-check me-2"></i>Date de r√©ception</h6>
                        <p>${formatDate(props.date_reception)}</p>
                        ` : ''}
                    </div>
                </div>
                <hr>
                <h6><i class="fas fa-clipboard me-2"></i>Description</h6>
                <p>${props.sous_livrable}</p>
                ${props.observations ? `
                <h6><i class="fas fa-sticky-note me-2"></i>Observations</h6>
                <p>${props.observations}</p>
                ` : ''}
            `;
        }
        
        // Afficher la modal
        const modalElement = document.getElementById('lancementModal');
        if (modalElement && typeof bootstrap !== 'undefined') {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
    }
    
    function getStatusColor(status) {
        const colors = {
            'planifie': 'secondary',
            'en_cours': 'warning',
            'termine': 'success',
            'en_attente': 'info'
        };
        return colors[status] || 'secondary';
    }
    
    function formatDate(date) {
        if (!date) return 'N/A';
        try {
            if (typeof date === 'string') {
                return new Date(date).toLocaleDateString('fr-FR');
            }
            return date.toLocaleDateString('fr-FR');
        } catch (e) {
            return date.toString();
        }
    }
    
    // ========================================================================================
    // SECTION 7: FONCTION PRINCIPALE - SOLUTION ROBUSTE
    // ========================================================================================
    
    async function initializePlanning() {
        initializationAttempts++;
        console.log(`üöÄ Tentative d'initialisation #${initializationAttempts}...`);
        
        try {
            // √âtape 1: V√©rifications pr√©liminaires
            if (typeof FullCalendar === 'undefined') {
                throw new Error('FullCalendar non charg√©');
            }
            
            // √âtape 2: Chargement de la configuration
            if (!loadConfig()) {
                console.warn('‚ö†Ô∏è Configuration par d√©faut utilis√©e');
            }
            
            // √âtape 3: Attendre que le DOM soit compl√®tement stable
            if (document.readyState !== 'complete') {
                console.log('‚è≥ Attente du chargement complet de la page...');
                await new Promise(resolve => {
                    const checkReady = () => {
                        if (document.readyState === 'complete') {
                            resolve();
                        } else {
                            setTimeout(checkReady, 10);
                        }
                    };
                    checkReady();
                });
            }
            
            // √âtape 4: V√©rifier que l'√©l√©ment calendrier existe et est pr√™t
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl) {
                throw new Error('√âl√©ment #calendar non trouv√©');
            }
            
            // Attendre que l'√©l√©ment ait des dimensions
            let dimensions = calendarEl.getBoundingClientRect();
            let waitTime = 0;
            while ((dimensions.width === 0 || dimensions.height === 0) && waitTime < 2000) {
                console.log('‚è≥ Attente des dimensions du calendrier...');
                await new Promise(resolve => setTimeout(resolve, 100));
                dimensions = calendarEl.getBoundingClientRect();
                waitTime += 100;
            }
            
            console.log('üìê Dimensions du calendrier:', dimensions);
            
            // √âtape 5: Chargement des donn√©es
            console.log('üì° Chargement des donn√©es...');
            let lancements = getFallbackData();
            console.log('üìã Donn√©es fallback:', lancements.length);
            
            // Charger des donn√©es fra√Æches si n√©cessaire
            if (!lancements || lancements.length === 0) {
                console.log('üì° Chargement via API...');
                lancements = await loadAllLancements();
            }
            
            // √âtape 6: Transformation des donn√©es
            const events = transformToCalendarEvents(lancements);
            console.log('üéØ √âv√©nements finaux:', events.length);
            
            // √âtape 7: Initialisation du calendrier
            console.log('üóìÔ∏è Initialisation du calendrier...');
            const success = initializeCalendar(events);
            
            if (!success) {
                throw new Error('√âchec de l\'initialisation du calendrier');
            }
            
            // √âtape 8: Configuration des contr√¥les
            setupControls();
            
            console.log('‚úÖ Planning initialis√© avec succ√®s!');
            
            // √âtape 9: Mise √† jour en arri√®re-plan
            setTimeout(async () => {
                try {
                    console.log('üîÑ Actualisation en arri√®re-plan...');
                    const freshData = await loadAllLancements();
                    if (freshData.length !== lancements.length) {
                        console.log('üìä Nouvelles donn√©es disponibles');
                        const freshEvents = transformToCalendarEvents(freshData);
                        allEvents = freshEvents;
                        if (calendar) {
                            calendar.removeAllEvents();
                            freshEvents.forEach(event => calendar.addEvent(event));
                            setTimeout(() => {
                                calendar.updateSize();
                            }, 100);
                        }
                    }
                } catch (e) {
                    console.log('‚ö†Ô∏è Erreur actualisation arri√®re-plan:', e);
                }
            }, 3000);
            
            return true;
            
        } catch (error) {
            console.error(`‚ùå Erreur initialisation (tentative ${initializationAttempts}):`, error);
            
            // Tentative de r√©cup√©ration
            if (initializationAttempts < MAX_INIT_ATTEMPTS) {
                console.log(`üîÑ Nouvelle tentative dans 1 seconde...`);
                setTimeout(() => {
                    initializePlanning();
                }, 1000);
                return false;
            } else {
                console.error('üí• √âchec d√©finitif de l\'initialisation');
                showError('Erreur fatale: ' + error.message);
                return false;
            }
        }
    }
    
    // ========================================================================================
    // SECTION 8: √âCOUTEURS D'√âV√âNEMENTS ET OPTIMISATIONS
    // ========================================================================================
    
    // Gestion du redimensionnement
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            if (calendar) {
                console.log('üîÑ Redimensionnement d√©tect√©, mise √† jour...');
                calendar.updateSize();
            }
        }, 150);
    });
    
    // Gestion de la visibilit√© de la page
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden && calendar) {
            console.log('üëÅÔ∏è Page redevenue visible, actualisation...');
            setTimeout(() => {
                calendar.updateSize();
            }, 100);
        }
    });
    
    // Nettoyage avant fermeture
    window.addEventListener('beforeunload', () => {
        if (calendar) {
            try {
                calendar.destroy();
                console.log('üßπ Calendrier nettoy√©');
            } catch (e) {
                console.warn('‚ö†Ô∏è Erreur nettoyage calendrier:', e);
            }
        }
    });
    
    // ========================================================================================
    // SECTION 9: LANCEMENT DE L'INITIALISATION
    // ========================================================================================
    
    console.log('üé¨ D√©marrage de l\'initialisation du planning...');
    
    // SOLUTION FINALE: Lancement avec d√©lai optimal
    // Ce d√©lai permet de s'assurer que tout le DOM et les styles sont pr√™ts
    setTimeout(() => {
        initializePlanning();
    }, 150);
    
    // Fallback de s√©curit√© si l'initialisation √©choue
    setTimeout(() => {
        if (!calendar || initializationAttempts === 0) {
            console.log('üÜò Fallback de s√©curit√© activ√©');
            initializePlanning();
        }
    }, 2000);
});
</script>
{% endblock %}