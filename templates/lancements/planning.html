{% extends 'base/base.html' %}
{% load static %}

{% block title %}Planning des Lancements{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'lancements:list' %}">Lancements</a></li>
    <li class="breadcrumb-item active">Planning</li>
{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css" rel="stylesheet">
<style>
.planning-header {
    background: linear-gradient(135deg, #17a2b8, #007bff);
    color: white;
    padding: 2rem;
    border-radius: 15px;
    margin-bottom: 2rem;
}

.calendar-card {
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border: none;
    border-radius: 15px;
    min-height: 600px;
}

.calendar-controls {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1rem;
}

.view-toggle button {
    border: 1px solid #dee2e6;
    background: white;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    margin: 0 0.25rem;
    cursor: pointer;
    transition: all 0.2s;
}

.view-toggle button.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.month-navigation {
    display: flex;
    align-items: center;
    gap: 1rem;
}

/* Styles FullCalendar personnalis√©s */
.fc-event {
    border-radius: 4px;
    border: none !important;
    padding: 2px 4px;
    font-size: 0.75rem;
    cursor: pointer;
}

.fc-event.lancement-planifie {
    background-color: #6c757d !important;
    color: white !important;
}

.fc-event.lancement-en_cours {
    background-color: #ffc107 !important;
    color: #212529 !important;
}

.fc-event.lancement-termine {
    background-color: #28a745 !important;
    color: white !important;
}

.fc-event.lancement-en_attente {
    background-color: #17a2b8 !important;
    color: white !important;
}

.legend-item {
    display: flex;
    align-items: center;
    margin: 0.5rem 0;
}

.legend-color {
    width: 20px;
    height: 15px;
    border-radius: 3px;
    margin-right: 0.5rem;
}

.stats-card {
    border-left: 4px solid #17a2b8;
}

/* Styles pour le debug (√† retirer en production) */
.debug-info {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 10px;
    margin-bottom: 15px;
    font-size: 0.875rem;
}

#calendar {
    min-height: 500px;
}

.fc {
    min-height: 500px;
}

.loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 200px;
}

/* Emp√™cher le freeze lors des transitions */
.fc-view-harness {
    overflow: hidden;
}

.fc-daygrid-event-harness {
    position: relative;
}
</style>
{% endblock %}

{% block content %}
<!-- Donn√©es JSON pour JavaScript -->
<script type="application/json" id="lancements-json">{{ lancements_json|safe }}</script>

<!-- Informations de debug -->
{% if debug_info %}
<div class="debug-info">
    <strong>üîç Debug Planning:</strong>
    <span class="badge bg-primary">{{ debug_info.total_lancements_db }} total en DB</span>
    <span class="badge bg-info">{{ debug_info.lancements_month }} ce mois</span>
    <span class="badge bg-success">{{ debug_info.lancements_json_length }} caract√®res JSON</span>
    {% if debug_info.lancements_json_length <= 2 %}
        <span class="badge bg-warning">‚ö†Ô∏è JSON vide ou invalide d√©tect√©</span>
    {% endif %}
    <br><small>URL API: {% url 'lancements:api_data' %}</small>
</div>
{% endif %}

<div class="container-fluid">
    <!-- En-t√™te -->
    <div class="planning-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="fas fa-calendar-alt me-3"></i>
                    Planning des Lancements
                </h1>
                <p class="mb-0">Vue d'ensemble des lancements par date de lancement pr√©vue</p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="view-toggle">
                    <button type="button" class="btn-view active" data-view="dayGridMonth">
                        <i class="fas fa-calendar"></i> Mois
                    </button>
                    <button type="button" class="btn-view" data-view="timeGridWeek">
                        <i class="fas fa-calendar-week"></i> Semaine
                    </button>
                    <button type="button" class="btn-view" data-view="timeGridDay">
                        <i class="fas fa-calendar-day"></i> Jour
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-9">
            <!-- Contr√¥les du calendrier -->
            <div class="calendar-controls">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="month-navigation">
                            <button class="btn btn-outline-primary" id="prevMonth">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h4 class="mb-0" id="currentMonth">{{ current_month|date:"F Y" }}</h4>
                            <button class="btn btn-outline-primary" id="nextMonth">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <div class="btn-group">
                            <button class="btn btn-outline-info" id="todayBtn">
                                <i class="fas fa-crosshairs"></i> Aujourd'hui
                            </button>
                            {% if can_create %}
                            <a href="{% url 'lancements:create' %}" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Nouveau Lancement
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendrier principal -->
            <div class="card calendar-card">
                <div class="card-body p-2">
                    <div id="calendar-loading" class="loading-spinner">
                        <div>
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                            <p class="mt-2 text-center">Chargement du planning...</p>
                        </div>
                    </div>
                    <div id="calendar" style="display: none;"></div>
                    <div id="calendar-error" class="alert alert-danger" style="display: none;">
                        <h5><i class="fas fa-exclamation-triangle"></i> Erreur de chargement</h5>
                        <p id="error-message">Une erreur s'est produite lors du chargement du calendrier.</p>
                        <button class="btn btn-outline-danger" onclick="location.reload()">
                            <i class="fas fa-sync"></i> Recharger la page
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar droite -->
        <div class="col-lg-3">
            <!-- L√©gende -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>L√©gende
                    </h5>
                </div>
                <div class="card-body">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #6c757d;"></div>
                        <span>Planifi√©</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ffc107;"></div>
                        <span>En cours</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #28a745;"></div>
                        <span>Termin√©</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #17a2b8;"></div>
                        <span>En attente</span>
                    </div>
                </div>
            </div>

            <!-- Statistiques rapides -->
            <div class="card stats-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Statistiques du mois
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <h4 class="text-primary">{{ stats.total_month|default:0 }}</h4>
                            <small class="text-muted">Total</small>
                        </div>
                        <div class="col-6 mb-3">
                            <h4 class="text-warning">{{ stats.en_cours_month|default:0 }}</h4>
                            <small class="text-muted">En cours</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success">{{ stats.termines_month|default:0 }}</h4>
                            <small class="text-muted">Termin√©s</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-info">{{ stats.planifies_month|default:0 }}</h4>
                            <small class="text-muted">Planifi√©s</small>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="text-center">
                        <strong class="text-info">{{ stats.poids_total_month|default:0 }} kg</strong>
                        <br><small class="text-muted">Poids total du mois</small>
                    </div>
                </div>
            </div>

            <!-- Filtres -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Filtres
                    </h5>
                </div>
                <div class="card-body">
                    <form id="filterForm">
                        <div class="mb-3">
                            <label class="form-label">Atelier</label>
                            <select class="form-select form-select-sm" id="filterAtelier">
                                <option value="">Tous les ateliers</option>
                                {% for atelier in ateliers %}
                                    <option value="{{ atelier.id }}">{{ atelier.nom_atelier }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Statut</label>
                            <select class="form-select form-select-sm" id="filterStatut">
                                <option value="">Tous les statuts</option>
                                <option value="planifie">Planifi√©</option>
                                <option value="en_cours">En cours</option>
                                <option value="termine">Termin√©</option>
                                <option value="en_attente">En attente</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Collaborateur</label>
                            <select class="form-select form-select-sm" id="filterCollaborateur">
                                <option value="">Tous</option>
                                {% for collaborateur in collaborateurs %}
                                    <option value="{{ collaborateur.id }}">{{ collaborateur.get_full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <button type="button" class="btn btn-outline-primary btn-sm w-100 mb-2" id="applyFilters">
                            <i class="fas fa-search"></i> Appliquer
                        </button>
                        
                        <button type="button" class="btn btn-outline-secondary btn-sm w-100" id="clearFilters">
                            <i class="fas fa-times"></i> Effacer
                        </button>
                    </form>
                </div>
            </div>

            <!-- Actions rapides -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>Actions Rapides
                    </h5>
                </div>
                <div class="card-body d-grid gap-2">
                    <a href="{% url 'lancements:list' %}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-list"></i> Liste des lancements
                    </a>
                    
                    {% if can_create %}
                    <a href="{% url 'lancements:create' %}" class="btn btn-outline-success btn-sm">
                        <i class="fas fa-plus"></i> Nouveau lancement
                    </a>
                    {% endif %}
                    
                    <button class="btn btn-outline-info btn-sm" onclick="window.print()">
                        <i class="fas fa-print"></i> Imprimer planning
                    </button>
                    
                    <button class="btn btn-outline-warning btn-sm" id="refreshData">
                        <i class="fas fa-sync"></i> Actualiser
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour les d√©tails du lancement -->
<div class="modal fade" id="lancementModal" tabindex="-1" aria-labelledby="lancementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="lancementModalLabel">
                    <i class="fas fa-rocket me-2"></i>
                    <span id="modalTitle">D√©tails du Lancement</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalContent">
                <div class="text-center p-3">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <a href="#" class="btn btn-primary" id="viewDetailsBtn">Voir tous les d√©tails</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/locales/fr.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== Initialisation du planning ===');
    
    // Variables globales
    let calendar;
    let allEvents = [];
    let isNavigating = false;
    let navigationTimeout = null;
    
    // Configuration de l'URL API
    const API_URL = '{% url "lancements:api_data" %}';
    console.log('URL API:', API_URL);
    
    // Debounce pour √©viter les appels multiples
    function debounce(func, delay) {
        let timeoutId;
        return function (...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => func.apply(this, args), delay);
        };
    }
    
    // Fonctions utilitaires
    function showError(message) {
        console.error('Erreur:', message);
        const loadingEl = document.getElementById('calendar-loading');
        const errorEl = document.getElementById('calendar-error');
        const errorMsg = document.getElementById('error-message');
        
        if (loadingEl) loadingEl.style.display = 'none';
        if (errorEl) {
            errorEl.style.display = 'block';
            if (errorMsg) errorMsg.textContent = message;
        }
    }
    
    function hideLoadingShowCalendar() {
        const loadingEl = document.getElementById('calendar-loading');
        const calendarEl = document.getElementById('calendar');
        const errorEl = document.getElementById('calendar-error');
        
        if (loadingEl) loadingEl.style.display = 'none';
        if (errorEl) errorEl.style.display = 'none';
        if (calendarEl) calendarEl.style.display = 'block';
    }
    
    // Fonction pour charger les donn√©es via AJAX avec cache
    let dataCache = new Map();
    
    async function loadLancementsData(start = null, end = null, useCache = true) {
        const cacheKey = `${start}-${end}`;
        
        if (useCache && dataCache.has(cacheKey)) {
            console.log('üì¶ Utilisation du cache pour:', cacheKey);
            return dataCache.get(cacheKey);
        }
        
        try {
            console.log('Chargement des donn√©es via API...');
            
            const params = new URLSearchParams();
            if (start) params.append('start', start);
            if (end) params.append('end', end);
            
            const url = `${API_URL}${params.toString() ? '?' + params.toString() : ''}`;
            console.log('URL finale:', url);
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // Timeout 10s
            
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('Donn√©es API re√ßues:', data);
            
            if (data.success && Array.isArray(data.events)) {
                dataCache.set(cacheKey, data.events);
                return data.events;
            } else {
                console.warn('Donn√©es API invalides:', data);
                return [];
            }
            
        } catch (error) {
            if (error.name === 'AbortError') {
                console.warn('Requ√™te API annul√©e (timeout)');
            } else {
                console.error('Erreur lors du chargement API:', error);
            }
            // Fallback vers les donn√©es Django
            return getDjangoData();
        }
    }
    
    // Fonction fallback pour r√©cup√©rer les donn√©es depuis Django
    function getDjangoData() {
        try {
            console.log('Tentative de r√©cup√©ration des donn√©es Django...');
            const lancementsJson = document.getElementById('lancements-json');
            
            if (!lancementsJson || !lancementsJson.textContent.trim()) {
                console.warn('√âl√©ment lancements-json non trouv√© ou vide');
                return [];
            }
            
            const jsonText = lancementsJson.textContent.trim();
            
            if (jsonText === '[]' || jsonText === '') {
                console.log('Donn√©es Django vides');
                return [];
            }
            
            const data = JSON.parse(jsonText);
            console.log('Donn√©es Django pars√©es:', Array.isArray(data) ? data.length + ' √©l√©ments' : 'Format invalide');
            
            return Array.isArray(data) ? data : [];
            
        } catch (e) {
            console.error('Erreur lors du parsing des donn√©es Django:', e);
            return [];
        }
    }
    
    // Transformation des donn√©es pour FullCalendar
    function transformDataForCalendar(lancements) {
        if (!Array.isArray(lancements)) {
            console.error('lancements n\'est pas un tableau:', typeof lancements);
            return [];
        }
        
        console.log('Transformation de', lancements.length, 'lancements');
        
        return lancements.map((lancement, index) => {
            try {
                return {
                    id: lancement.id?.toString() || `temp-${index}`,
                    title: lancement.num_lanc || `L-${lancement.id || index}`,
                    start: lancement.date_lancement,
                    className: ['lancement-' + (lancement.statut || 'planifie')],
                    extendedProps: {
                        ...lancement,
                        num_lanc: lancement.num_lanc || `L-${lancement.id || index}`,
                        statut_display: lancement.statut_display || lancement.statut || 'Planifi√©',
                        atelier_nom: lancement.atelier_nom || 'Aucun atelier',
                        collaborateur_nom: lancement.collaborateur_nom || 'Aucun collaborateur',
                        affaire_code: lancement.affaire_code || 'N/A',
                        client: lancement.client || 'N/A',
                        sous_livrable: lancement.sous_livrable || 'Pas de description',
                        poids_total: lancement.poids_total || 0
                    }
                };
            } catch (e) {
                console.error('Erreur transformation lancement:', e, lancement);
                return null;
            }
        }).filter(event => event !== null);
    }

    // Chargement diff√©r√© des donn√©es par p√©riode
    const deferredDataLoad = debounce(async function(dateInfo) {
        if (isNavigating) return;
        
        isNavigating = true;
        console.log('üîÑ Chargement diff√©r√© pour:', dateInfo.startStr, '√†', dateInfo.endStr);
        
        try {
            const startDate = dateInfo.start.toISOString().split('T')[0];
            const endDate = dateInfo.end.toISOString().split('T')[0];
            
            const lancements = await loadLancementsData(startDate, endDate);
            const events = transformDataForCalendar(lancements);
            
            if (calendar && events.length > 0) {
                console.log('üìä Mise √† jour avec', events.length, '√©v√©nements');
                
                // Supprimer les √©v√©nements existants et ajouter les nouveaux
                calendar.removeAllEvents();
                
                // Ajouter les nouveaux √©v√©nements un par un pour √©viter les conflits
                setTimeout(() => {
                    events.forEach((event, index) => {
                        setTimeout(() => {
                            if (calendar) {
                                calendar.addEvent(event);
                            }
                        }, index * 10); // D√©lai de 10ms entre chaque ajout
                    });
                    
                    setTimeout(() => {
                        isNavigating = false;
                    }, events.length * 10 + 100);
                }, 50);
            } else {
                isNavigating = false;
            }
        } catch (error) {
            console.error('Erreur lors du chargement diff√©r√©:', error);
            isNavigating = false;
        }
    }, 300);

    // Initialisation du calendrier FullCalendar
    function initializeCalendar(initialEvents) {
        const calendarEl = document.getElementById('calendar');
        
        if (!calendarEl) {
            showError('√âl√©ment #calendar non trouv√© dans le DOM!');
            return;
        }

        try {
            console.log('Initialisation du calendrier avec', initialEvents.length, '√©v√©nements');
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'fr',
                height: 'auto',
                headerToolbar: false,
                events: initialEvents,
                
                // Configuration optimis√©e
                eventDisplay: 'block',
                dayMaxEvents: 3,
                moreLinkClick: 'popover',
                
                // Performance
                eventDidMount: function(info) {
                    const props = info.event.extendedProps;
                    info.el.title = `${props.num_lanc}
Affaire: ${props.affaire_code}
Client: ${props.client}
Atelier: ${props.atelier_nom}
Statut: ${props.statut_display}
Poids: ${props.poids_total} kg`;
                },
                
                eventClick: function(info) {
                    console.log('Clic sur √©v√©nement:', info.event.extendedProps);
                    showLancementDetails(info.event);
                },
                
                eventContent: function(arg) {
                    const props = arg.event.extendedProps;
                    const statusColors = {
                        'planifie': '#6c757d',
                        'en_cours': '#ffc107',
                        'termine': '#28a745',
                        'en_attente': '#17a2b8'
                    };
                    
                    const color = statusColors[props.statut] || '#6c757d';
                    const textColor = (props.statut === 'en_cours') ? '#212529' : 'white';
                    
                    return {
                        html: `<div style="font-size: 0.75rem; padding: 2px 4px; background-color: ${color}; color: ${textColor}; border-radius: 3px; overflow: hidden;">
                            <div style="font-weight: bold;">${props.num_lanc}</div>
                            <div style="font-size: 0.6rem;">${(props.atelier_nom || 'Sans atelier').substring(0, 15)}</div>
                        </div>`
                    };
                },
                
                // Gestion des changements de dates avec debounce
                datesSet: function(dateInfo) {
                    console.log('Changement de dates:', dateInfo.start, '√†', dateInfo.end);
                    updateMonthDisplay();
                    
                    // Charger les donn√©es pour cette p√©riode si n√©cessaire
                    if (!isNavigating) {
                        deferredDataLoad(dateInfo);
                    }
                },
                
                loading: function(isLoading) {
                    console.log('FullCalendar loading:', isLoading);
                    if (isLoading && !isNavigating) {
                        // Optionnel: afficher un indicateur de chargement
                    }
                }
            });
            
            calendar.render();
            hideLoadingShowCalendar();
            
            console.log('‚úÖ Calendrier rendu avec succ√®s');
            
            // Sauvegarder les √©v√©nements pour les filtres
            allEvents = initialEvents;
            
        } catch (e) {
            console.error('‚ùå Erreur lors de l\'initialisation du calendrier:', e);
            showError('Erreur lors de l\'initialisation du calendrier: ' + e.message);
        }
    }

    // Navigation du calendrier avec protection contre les clics multiples
    function setupNavigation() {
        console.log('Configuration de la navigation...');
        
        const prevButton = document.getElementById('prevMonth');
        const nextButton = document.getElementById('nextMonth');
        const todayButton = document.getElementById('todayBtn');
        const refreshButton = document.getElementById('refreshData');

        if (prevButton) {
            prevButton.addEventListener('click', debounce(function(e) {
                e.preventDefault();
                if (!isNavigating && calendar) {
                    console.log('üëà Mois pr√©c√©dent');
                    calendar.prev();
                }
            }, 200));
            console.log('‚úÖ Bouton pr√©c√©dent configur√©');
        }

        if (nextButton) {
            nextButton.addEventListener('click', debounce(function(e) {
                e.preventDefault();
                if (!isNavigating && calendar) {
                    console.log('üëâ Mois suivant');
                    calendar.next();
                }
            }, 200));
            console.log('‚úÖ Bouton suivant configur√©');
        }

        if (todayButton) {
            todayButton.addEventListener('click', debounce(function(e) {
                e.preventDefault();
                if (!isNavigating && calendar) {
                    console.log('üéØ Retour √† aujourd\'hui');
                    calendar.today();
                }
            }, 200));
            console.log('‚úÖ Bouton aujourd\'hui configur√©');
        }
        
        if (refreshButton) {
            refreshButton.addEventListener('click', debounce(function(e) {
                e.preventDefault();
                console.log('üîÑ Actualisation des donn√©es');
                dataCache.clear(); // Vider le cache
                location.reload();
            }, 500));
            console.log('‚úÖ Bouton actualiser configur√©');
        }
    }

    // Changement de vue
    function setupViewToggle() {
        console.log('Configuration du toggle de vue...');
        
        document.querySelectorAll('.btn-view').forEach(button => {
            button.addEventListener('click', debounce(function(e) {
                e.preventDefault();
                if (isNavigating) return;
                
                const view = this.dataset.view;
                console.log('üîÑ Changement de vue:', view);
                
                // Mettre √† jour l'√©tat visuel des boutons
                document.querySelectorAll('.btn-view').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // Changer la vue du calendrier
                if (calendar) {
                    calendar.changeView(view);
                }
            }, 200));
        });
        
        console.log('‚úÖ Toggle de vue configur√©');
    }

    // Mise √† jour de l'affichage du mois
    function updateMonthDisplay() {
        const monthTitle = document.getElementById('currentMonth');
        if (!monthTitle || !calendar) return;
        
        const currentDate = calendar.getDate();
        const monthNames = [
            'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
            'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
        ];
        const monthDisplay = monthNames[currentDate.getMonth()] + ' ' + currentDate.getFullYear();
        monthTitle.textContent = monthDisplay;
    }

    // Configuration des filtres
    function setupFilters() {
        console.log('Configuration des filtres...');
        
        const applyFiltersBtn = document.getElementById('applyFilters');
        const clearFiltersBtn = document.getElementById('clearFilters');

        if (applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', debounce(function(e) {
                e.preventDefault();
                console.log('üîç Application des filtres');
                applyFilters();
            }, 300));
            console.log('‚úÖ Bouton appliquer filtres configur√©');
        }

        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', debounce(function(e) {
                e.preventDefault();
                console.log('üóëÔ∏è Effacement des filtres');
                clearFilters();
            }, 300));
            console.log('‚úÖ Bouton effacer filtres configur√©');
        }
    }

    function applyFilters() {
        const atelierId = document.getElementById('filterAtelier')?.value || '';
        const statut = document.getElementById('filterStatut')?.value || '';
        const collaborateurId = document.getElementById('filterCollaborateur')?.value || '';

        console.log('üîç Filtres appliqu√©s:', { atelierId, statut, collaborateurId });

        const filteredEvents = allEvents.filter(event => {
            const props = event.extendedProps;
            let show = true;
            
            if (atelierId && props.atelier_id != atelierId) show = false;
            if (statut && props.statut !== statut) show = false;
            if (collaborateurId && props.collaborateur_id != collaborateurId) show = false;
            
            return show;
        });

        console.log('üìä √âv√©nements filtr√©s:', filteredEvents.length, '/', allEvents.length);

        if (calendar) {
            calendar.removeAllEvents();
            filteredEvents.forEach((event, index) => {
                setTimeout(() => {
                    if (calendar) {
                        calendar.addEvent(event);
                    }
                }, index * 5);
            });
        }
    }

    function clearFilters() {
        const form = document.getElementById('filterForm');
        if (form) form.reset();
        
        if (calendar && allEvents.length > 0) {
            calendar.removeAllEvents();
            allEvents.forEach((event, index) => {
                setTimeout(() => {
                    if (calendar) {
                        calendar.addEvent(event);
                    }
                }, index * 5);
            });
        }
    }

    // Affichage des d√©tails d'un lancement
    function showLancementDetails(event) {
        const props = event.extendedProps;
        console.log('üìã Affichage d√©tails:', props.num_lanc);
        
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const viewDetailsBtn = document.getElementById('viewDetailsBtn');

        if (modalTitle) modalTitle.textContent = `Lancement ${props.num_lanc}`;
        if (viewDetailsBtn) {
            const detailUrl = "{% url 'lancements:detail' 0 %}".replace('0', event.id);
            viewDetailsBtn.href = detailUrl;
        }
        
        if (modalContent) {
            modalContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-briefcase me-2"></i>Affaire</h6>
                        <p><strong>${props.affaire_code}</strong><br>
                        <small class="text-muted">${props.client}</small></p>
                        
                        <h6><i class="fas fa-industry me-2"></i>Atelier</h6>
                        <p>${props.atelier_nom}</p>
                        
                        <h6><i class="fas fa-user me-2"></i>Collaborateur</h6>
                        <p>${props.collaborateur_nom}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-flag me-2"></i>Statut</h6>
                        <p><span class="badge bg-${getStatusColor(props.statut)}">${props.statut_display}</span></p>
                        
                        <h6><i class="fas fa-weight me-2"></i>Poids Total</h6>
                        <p><strong>${props.poids_total} kg</strong></p>
                        
                        <h6><i class="fas fa-calendar me-2"></i>Date de lancement</h6>
                        <p>${formatDate(event.start)}</p>
                    </div>
                </div>
                <hr>
                <h6><i class="fas fa-clipboard me-2"></i>Description</h6>
                <p>${props.sous_livrable}</p>
            `;
        }
        
        // Afficher la modal
        const modalElement = document.getElementById('lancementModal');
        if (modalElement && typeof bootstrap !== 'undefined') {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
    }

    function getStatusColor(status) {
        const colors = {
            'planifie': 'secondary',
            'en_cours': 'warning',
            'termine': 'success',
            'en_attente': 'info'
        };
        return colors[status] || 'secondary';
    }

    function formatDate(date) {
        if (!date) return 'N/A';
        try {
            return new Date(date).toLocaleDateString('fr-FR');
        } catch (e) {
            return date.toString();
        }
    }

    // Fonction d'initialisation principale
    async function init() {
        try {
            console.log('üöÄ D√©but de l\'initialisation du planning...');
            
            // V√©rifier les d√©pendances
            if (!checkDependencies()) {
                return;
            }
            
            // V√©rifier que les √©l√©ments DOM existent
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl) {
                throw new Error('√âl√©ment #calendar non trouv√© dans le DOM');
            }
            
            console.log('‚úÖ √âl√©ments DOM trouv√©s');
            
            // Essayer de charger les donn√©es initiales
            console.log('üì° Tentative de chargement des donn√©es initiales...');
            
            // D'abord essayer les donn√©es Django (plus rapide)
            let lancements = getDjangoData();
            
            if (!lancements || lancements.length === 0) {
                console.log('üì° Aucune donn√©e Django, tentative via API...');
                lancements = await loadLancementsData();
            }
            
            console.log('üìä Donn√©es initiales:', lancements?.length || 0, 'lancements');
            
            if (!lancements || lancements.length === 0) {
                console.log('‚ö†Ô∏è Aucune donn√©e disponible');
                hideLoadingShowCalendar();
                const calendarEl = document.getElementById('calendar');
                if (calendarEl) {
                    
                    // Initialiser quand m√™me le calendrier vide
                    initializeCalendar([]);
                    
                    // Ajouter un message informatif
                    setTimeout(() => {
                        if (calendar) {
                            const viewEl = calendarEl.querySelector('.fc-view-harness');
                            if (viewEl) {
                                const infoDiv = document.createElement('div');
                                infoDiv.className = 'alert alert-info text-center m-3';
                                infoDiv.innerHTML = `
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Aucun lancement trouv√©</strong><br>
                                    <small>Aucun lancement n'est programm√© pour cette p√©riode.</small>
                                `;
                                viewEl.appendChild(infoDiv);
                            }
                        }
                    }, 500);
                }
            } else {
                // Transformer et initialiser le calendrier
                const events = transformDataForCalendar(lancements);
                console.log('üîÑ √âv√©nements transform√©s:', events.length);
                
                if (events.length > 0) {
                    initializeCalendar(events);
                } else {
                    console.warn('‚ö†Ô∏è Aucun √©v√©nement valide apr√®s transformation');
                    initializeCalendar([]);
                }
            }
            
            // Configurer les contr√¥les (toujours, m√™me sans donn√©es)
            setupNavigation();
            setupViewToggle();
            setupFilters();
            
            console.log('‚úÖ Planning initialis√© avec succ√®s');
            
        } catch (error) {
            console.error('‚ùå Erreur lors de l\'initialisation:', error);
            showError('Erreur lors de l\'initialisation du planning: ' + error.message);
        }
    }
    
    // V√©rification des d√©pendances
    function checkDependencies() {
        const issues = [];
        
        if (typeof FullCalendar === 'undefined') {
            issues.push('FullCalendar n\'est pas charg√©');
        }
        
        if (typeof bootstrap === 'undefined') {
            console.warn('‚ö†Ô∏è Bootstrap JS non d√©tect√© - certaines fonctionnalit√©s peuvent ne pas marcher');
        }
        
        if (issues.length > 0) {
            console.error('‚ùå D√©pendances manquantes:', issues);
            showError('D√©pendances manquantes: ' + issues.join(', '));
            return false;
        }
        
        console.log('‚úÖ Toutes les d√©pendances sont charg√©es');
        return true;
    }
    
    // Nettoyage √† la fermeture de la page
    window.addEventListener('beforeunload', function() {
        if (calendar) {
            console.log('üßπ Nettoyage du calendrier...');
            try {
                calendar.destroy();
            } catch (e) {
                console.warn('Erreur lors du nettoyage:', e);
            }
        }
        
        // Annuler tous les timeouts en cours
        if (navigationTimeout) {
            clearTimeout(navigationTimeout);
        }
    });
    
    // Lancer l'initialisation
    console.log('üèÅ D√©marrage de l\'initialisation...');
    init();
});
</script>
{% endblock %}