{% extends 'base/base.html' %}
{% load static %}
{% load weight_formatting %}

{% block title %}Liste des Lancements{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item active">Lancements</li>
{% endblock %}

{% block extra_css %}
<style>
.filters-card {
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: none;
}

.lancements-header {
    padding: 1.5rem 0;
    border-bottom: 3px solid #e83e8c;
    margin-bottom: 2rem;
}

.lancements-table {
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border: none;
}

.lancement-card {
    transition: all 0.3s ease;
    border-left: 4px solid #e83e8c;
}

.lancement-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.status-badge {
    font-size: 0.75rem;
    padding: 0.375rem 0.75rem;
    border-radius: 50px;
}

.weight-indicator {
    background: linear-gradient(90deg, #28a745, #17a2b8);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
}

.weight-display {
    font-family: 'Courier New', monospace;
    font-weight: 600;
    font-size: 0.85rem;
    background: #0f0013;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    border-left: 3px solid #17a2b8;
    margin-bottom: 0.25rem;
}

.weight-display.zero {
    opacity: 0.5;
    border-left-color: #6c757d;
}

.weight-display.assemblage {
    border-left-color: #007bff;
}

.weight-display.debitage {
    border-left-color: #28a745;
}

.production-type-badge {
    font-size: 0.65rem;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    background: linear-gradient(45deg, #fd7e14, #e83e8c);
    color: white;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    font-weight: 600;
}

.avatar {
    width: 40px;
    height: 40px;
    font-size: 0.875rem;
    font-weight: 500;
}

.empty-state {
    padding: 4rem 2rem;
}

.priority-high {
    border-left-color: #dc3545 !important;
}

.priority-medium {
    border-left-color: #ffc107 !important;
}

.priority-low {
    border-left-color: #28a745 !important;
}

.lancement-num {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    font-size: 0.9rem;
    background: #f8f9fa;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}

.weight-section {
    min-width: 140px;
}

.total-weight {
    background: #e9ecef;
    border: 2px solid #007bff;
    color: #007bff;
    font-weight: bold;
    text-align: center;
    padding: 0.3rem 0.5rem;
    border-radius: 6px;
    margin-top: 0.25rem;
}

.weight-details {
    font-size: 0.7rem;
    margin-top: 0.2rem;
}

.type-production-indicator {
    width: 8px;
    height: 40px;
    border-radius: 4px;
    margin-right: 0.5rem;
}

.type-assemblage {
    background: linear-gradient(180deg, #007bff, #0056b3);
}

.type-debitage {
    background: linear-gradient(180deg, #28a745, #20c997);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Main content -->
        <main class="col-12 px-md-4">
            <div class="lancements-header d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center">
                <h1 class="h2">
                    <i class="fas fa-rocket" style="margin-right: 18px; color: #e83e8c;"></i>
                    <span>Liste des Lancements</span>
                </h1>
                {% if can_create %}
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <a href="{% url 'lancements:create' %}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Nouveau Lancement
                        </a>
                        <a href="{% url 'lancements:planning' %}" class="btn btn-outline-info">
                            <i class="fas fa-calendar"></i> Planning
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Statistiques rapides - Mises à jour -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center bg-primary text-white">
                        <div class="card-body">
                            <i class="fas fa-rocket fa-2x mb-2"></i>
                            <h4>{{ stats.total_lancements|default:0 }}</h4>
                            <small>Total Lancements</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center bg-warning text-white">
                        <div class="card-body">
                            <i class="fas fa-clock fa-2x mb-2"></i>
                            <h4>{{ stats.en_cours|default:0 }}</h4>
                            <small>En Cours</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center bg-info text-white">
                        <div class="card-body">
                            <i class="fas fa-cogs fa-2x mb-2"></i>
                            <h4>{{ stats.assemblage|default:0 }}</h4>
                            <small>Assemblage</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center bg-success text-white">
                        <div class="card-body">
                            <i class="fas fa-cut fa-2x mb-2"></i>
                            <h4>{{ stats.debitage|default:0 }}</h4>
                            <small>Débitage</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistique du poids total -->
            {% if stats.poids_total > 0 %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card bg-gradient" style="background: linear-gradient(135deg, #28a745, #17a2b8);">
                        <div class="card-body text-center text-white">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <i class="fas fa-weight-hanging fa-3x mb-2"></i>
                                </div>
                                <div class="col-md-8">
                                    <h2 class="mb-1">{{ stats.poids_total|floatformat:3|default:0 }} kg</h2>
                                    <p class="mb-0">Poids total de production</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Filtres et recherche -->
            <div class="card filters-card mb-4">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label for="search" class="form-label">Recherche</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   value="{{ search_query }}" placeholder="Numéro, sous-livrable...">
                        </div>
                        <div class="col-md-2">
                            <label for="statut" class="form-label">Statut</label>
                            <select class="form-select" id="statut" name="statut">
                                <option value="">Tous</option>
                                <option value="planifie" {% if statut_filter == 'planifie' %}selected{% endif %}>Planifié</option>
                                <option value="en_cours" {% if statut_filter == 'en_cours' %}selected{% endif %}>En cours</option>
                                <option value="termine" {% if statut_filter == 'termine' %}selected{% endif %}>Terminé</option>
                                <option value="en_attente" {% if statut_filter == 'en_attente' %}selected{% endif %}>En attente</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="atelier" class="form-label">Atelier</label>
                            <select class="form-select" id="atelier" name="atelier">
                                <option value="">Tous</option>
                                {% for atelier in ateliers %}
                                    <option value="{{ atelier.id }}" {% if atelier_filter == atelier.id|stringformat:"s" %}selected{% endif %}>
                                        {{ atelier.nom_atelier }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="affaire" class="form-label">Affaire</label>
                            <select class="form-select" id="affaire" name="affaire">
                                <option value="">Toutes</option>
                                {% for affaire in affaires %}
                                    <option value="{{ affaire.id }}" {% if affaire_filter == affaire.id|stringformat:"s" %}selected{% endif %}>
                                        {{ affaire.code_affaire }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="date_from" class="form-label">Date début</label>
                            <input type="date" class="form-control" id="date_from" name="date_from" value="{{ date_from }}">
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="submit" class="btn btn-outline-primary me-2">
                                <i class="fas fa-search"></i>
                            </button>
                            <a href="{% url 'lancements:list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i>
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tableau des lancements -->
            <div class="card lancements-table">
                <div class="card-body">
                    {% if page_obj %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Numéro</th>
                                        <th>Affaire</th>
                                        <th>Sous-livrable</th>
                                        <th>Atelier</th>
                                        <th>Collaborateur</th>
                                        <th>Production</th>
                                        <th>Date Lancement</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for lancement in page_obj %}
                                        <tr class="lancement-card">
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="type-production-indicator type-{{ lancement.type_production }}"></div>
                                                    <div>
                                                        <span class="lancement-num">{{ lancement.num_lanc }}</span>
                                                        <div class="production-type-badge">{{ lancement.get_type_production_display }}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div>
                                                    <strong>{{ lancement.affaire.code_affaire }}</strong><br>
                                                    <small class="text-muted">{{ lancement.affaire.client|truncatechars:20 }}</small>
                                                </div>
                                            </td>
                                            <td>
                                                <div style="max-width: 200px;">
                                                    {{ lancement.sous_livrable|truncatechars:50 }}
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="icon-container bg-info text-white rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 35px; height: 35px; font-size: 0.8rem;">
                                                        <i class="fas fa-industry"></i>
                                                    </div>
                                                    <div>
                                                        <strong>{{ lancement.atelier.nom_atelier }}</strong><br>
                                                        <small class="text-muted">{{ lancement.atelier.get_type_atelier_display }}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar bg-primary text-white rounded-circle me-2 d-flex align-items-center justify-content-center">
                                                        {{ lancement.collaborateur.nom_collaborateur.0 }}{{ lancement.collaborateur.prenom_collaborateur.0 }}
                                                    </div>
                                                    <span>{{ lancement.collaborateur.get_full_name }}</span>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="weight-section">
                                                    {% if lancement.type_production == 'assemblage' %}
                                                        <div class="weight-display assemblage {% if lancement.poids_assemblage == 0 %}zero{% endif %}">
                                                            <small>Assemblage:</small><br>
                                                            <strong>{{ lancement.poids_assemblage|format_weight }}</strong>
                                                        </div>
                                                    {% elif lancement.type_production == 'debitage' %}
                                                        {% if lancement.poids_debitage_1 and lancement.poids_debitage_1 > 0 %}
                                                        <div class="weight-display debitage {% if lancement.poids_debitage_1 == 0 %}zero{% endif %}">
                                                            <small>Débitage 1:</small><br>
                                                            <strong>{{ lancement.poids_debitage_1|format_weight }}</strong>
                                                        </div>
                                                        {% endif %}
                                                        {% if lancement.poids_debitage_2 and lancement.poids_debitage_2 > 0 %}
                                                        <div class="weight-display debitage {% if lancement.poids_debitage_2 == 0 %}zero{% endif %}">
                                                            <small>Débitage 2:</small><br>
                                                            <strong>{{ lancement.poids_debitage_2|format_weight }}</strong>
                                                        </div>
                                                        {% endif %}
                                                    {% endif %}
                                                    
                                                    {% if lancement.get_poids_total > 0 %}
                                                    <div class="total-weight">
                                                        <strong>{{ lancement.get_poids_total_display }}</strong>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                <div>
                                                    <strong>{{ lancement.date_lancement|date:"d/m/Y" }}</strong><br>
                                                    <small class="text-muted">Reçu: {{ lancement.date_reception|date:"d/m/Y" }}</small>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge status-badge 
                                                    {% if lancement.statut == 'planifie' %}bg-secondary
                                                    {% elif lancement.statut == 'en_cours' %}bg-warning
                                                    {% elif lancement.statut == 'termine' %}bg-success
                                                    {% elif lancement.statut == 'en_attente' %}bg-info
                                                    {% else %}bg-secondary{% endif %}">
                                                    {{ lancement.get_statut_display }}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <a href="{% url 'lancements:detail' lancement.pk %}" 
                                                       class="btn btn-sm btn-outline-info" title="Voir détails">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    {% if can_update %}
                                                        <a href="{% url 'lancements:edit' lancement.pk %}" 
                                                           class="btn btn-sm btn-outline-warning" title="Modifier">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                    {% endif %}
                                                    {% if can_delete %}
                                                        <a href="{% url 'lancements:delete' lancement.pk %}" 
                                                           class="btn btn-sm btn-outline-danger" title="Supprimer">
                                                            <i class="fas fa-trash"></i>
                                                        </a>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        {% if page_obj.has_other_pages %}
                            <nav aria-label="Navigation pagination">
                                <ul class="pagination justify-content-center">
                                    {% if page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if statut_filter %}&statut={{ statut_filter }}{% endif %}{% if atelier_filter %}&atelier={{ atelier_filter }}{% endif %}{% if affaire_filter %}&affaire={{ affaire_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}">
                                                &laquo; Première
                                            </a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if statut_filter %}&statut={{ statut_filter }}{% endif %}{% if atelier_filter %}&atelier={{ atelier_filter }}{% endif %}{% if affaire_filter %}&affaire={{ affaire_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}">
                                                Précédente
                                            </a>
                                        </li>
                                    {% endif %}

                                    <li class="page-item active">
                                        <span class="page-link">
                                            Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}
                                        </span>
                                    </li>

                                    {% if page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if statut_filter %}&statut={{ statut_filter }}{% endif %}{% if atelier_filter %}&atelier={{ atelier_filter }}{% endif %}{% if affaire_filter %}&affaire={{ affaire_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}">
                                                Suivante
                                            </a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if statut_filter %}&statut={{ statut_filter }}{% endif %}{% if atelier_filter %}&atelier={{ atelier_filter }}{% endif %}{% if affaire_filter %}&affaire={{ affaire_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}">
                                                Dernière &raquo;
                                            </a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% endif %}

                        <div class="text-muted mt-3">
                            Affichage de {{ page_obj.start_index }} à {{ page_obj.end_index }} 
                            sur {{ page_obj.paginator.count }} lancements
                        </div>
                    {% else %}
                        <div class="empty-state text-center py-5">
                            <i class="fas fa-rocket fa-3x text-muted mb-3"></i>
                            <h4>Aucun lancement trouvé</h4>
                            <p class="text-muted">
                                {% if search_query or statut_filter or atelier_filter or affaire_filter %}
                                    Aucun lancement ne correspond aux critères de recherche.
                                {% else %}
                                    Il n'y a aucun lancement enregistré.
                                {% endif %}
                            </p>
                            {% if can_create %}
                                <a href="{% url 'lancements:create' %}" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Créer le premier lancement
                                </a>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}