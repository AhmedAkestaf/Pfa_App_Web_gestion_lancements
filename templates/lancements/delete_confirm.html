{% extends 'base/base.html' %}
{% load static %}

{% block title %}Supprimer le Lancement {{ lancement.num_lanc }}{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'lancements:list' %}">Lancements</a></li>
    <li class="breadcrumb-item"><a href="{% url 'lancements:detail' lancement.pk %}">{{ lancement.num_lanc }}</a></li>
    <li class="breadcrumb-item active">Supprimer</li>
{% endblock %}

{% block extra_css %}
<style>
.delete-header {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
    padding: 2rem;
    border-radius: 15px;
    margin-bottom: 2rem;
}

.warning-card {
    border: 2px solid #dc3545;
    background: #f8d7da;
    border-radius: 15px;
}

.info-card {
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border: none;
    border-radius: 15px;
    border-left: 5px solid #dc3545;
}

.summary-row {
    padding: 0.75rem 0;
    border-bottom: 1px solid #dee2e6;
}

.summary-row:last-child {
    border-bottom: none;
}

.summary-label {
    font-weight: 600;
    color: #495057;
}

.summary-value {
    color: #212529;
}

.danger-icon {
    font-size: 4rem;
    color: #dc3545;
    opacity: 0.7;
}

.confirmation-box {
    background: #fff3cd;
    border: 2px solid #ffc107;
    padding: 1.5rem;
    border-radius: 10px;
    margin: 1rem 0;
}

.consequences-list {
    background: #f8d7da;
    border-left: 4px solid #dc3545;
    padding: 1rem;
    margin: 1rem 0;
}

.action-buttons {
    position: sticky;
    top: 20px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- En-tête de suppression -->
            <div class="delete-header text-center">
                <div class="danger-icon mb-3">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h1 class="mb-2">
                    <i class="fas fa-trash me-3"></i>
                    Confirmer la Suppression
                </h1>
                <p class="mb-0 fs-5">Vous êtes sur le point de supprimer définitivement ce lancement</p>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <!-- Avertissement principal -->
                    <div class="card warning-card mb-4">
                        <div class="card-body text-center py-4">
                            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                            <h4 class="text-danger">Attention ! Action Irréversible</h4>
                            <p class="mb-0">
                                Cette action supprimera définitivement le lancement <strong>{{ lancement.num_lanc }}</strong> 
                                et toutes les données associées. Cette opération ne peut pas être annulée.
                            </p>
                        </div>
                    </div>

                    <!-- Résumé du lancement à supprimer -->
                    <div class="card info-card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Détails du Lancement à Supprimer
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="summary-row">
                                        <div class="summary-label">Numéro de lancement</div>
                                        <div class="summary-value"><strong>{{ lancement.num_lanc }}</strong></div>
                                    </div>
                                    <div class="summary-row">
                                        <div class="summary-label">Affaire</div>
                                        <div class="summary-value">{{ lancement.affaire.code_affaire }} - {{ lancement.affaire.client }}</div>
                                    </div>
                                    <div class="summary-row">
                                        <div class="summary-label">Atelier</div>
                                        <div class="summary-value">{{ lancement.atelier.nom_atelier }}</div>
                                    </div>
                                    <div class="summary-row">
                                        <div class="summary-label">Collaborateur</div>
                                        <div class="summary-value">{{ lancement.collaborateur.get_full_name }}</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="summary-row">
                                        <div class="summary-label">Date de lancement</div>
                                        <div class="summary-value">{{ lancement.date_lancement|date:"d/m/Y" }}</div>
                                    </div>
                                    <div class="summary-row">
                                        <div class="summary-label">Statut</div>
                                        <div class="summary-value">
                                            <span class="badge 
                                                {% if lancement.statut == 'planifie' %}bg-secondary
                                                {% elif lancement.statut == 'en_cours' %}bg-warning text-dark
                                                {% elif lancement.statut == 'termine' %}bg-success
                                                {% elif lancement.statut == 'en_attente' %}bg-info
                                                {% else %}bg-secondary{% endif %}">
                                                {{ lancement.get_statut_display }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="summary-row">
                                        <div class="summary-label">Poids total</div>
                                        <div class="summary-value">{{ lancement.get_poids_total|floatformat:2 }} kg</div>
                                    </div>
                                    <div class="summary-row">
                                        <div class="summary-label">Date de création</div>
                                        <div class="summary-value">{{ lancement.created_at|date:"d/m/Y à H:i" }}</div>
                                    </div>
                                </div>
                            </div>

                            {% if lancement.sous_livrable %}
                            <div class="summary-row mt-3 pt-3 border-top">
                                <div class="summary-label">Description</div>
                                <div class="summary-value">{{ lancement.sous_livrable|truncatewords:20 }}</div>
                            </div>
                            {% endif %}

                            {% if lancement.observations %}
                            <div class="summary-row">
                                <div class="summary-label">Observations</div>
                                <div class="summary-value">{{ lancement.observations|truncatewords:15 }}</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Conséquences de la suppression -->
                    <div class="card info-card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="fas fa-list-ul me-2"></i>
                                Conséquences de la Suppression
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="consequences-list">
                                <h6 class="text-danger"><i class="fas fa-warning me-2"></i>Cette action entraînera :</h6>
                                <ul class="mb-0">
                                    <li>La suppression définitive du lancement <strong>{{ lancement.num_lanc }}</strong></li>
                                    <li>La perte de toutes les données de production associées</li>
                                    <li>La suppression de l'historique des modifications</li>
                                    <li>L'impact sur les statistiques de production de l'atelier</li>
                                    {% if lancement.statut == 'en_cours' %}
                                    <li class="text-danger"><strong>Attention :</strong> Ce lancement est actuellement en cours de production</li>
                                    {% endif %}
                                </ul>
                            </div>

                            <div class="alert alert-info">
                                <h6><i class="fas fa-lightbulb me-2"></i>Alternative recommandée</h6>
                                <p class="mb-0">
                                    Au lieu de supprimer ce lancement, vous pourriez envisager de :
                                </p>
                                <ul class="mt-2 mb-0">
                                    <li>Le marquer comme "Annulé" ou "En attente"</li>
                                    <li>Le modifier pour corriger les erreurs</li>
                                    <li>Le conserver pour l'historique</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Case de confirmation -->
                    <div class="confirmation-box">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="confirmDelete" required>
                            <label class="form-check-label fw-bold" for="confirmDelete">
                                Je comprends que cette action est irréversible et je confirme vouloir supprimer définitivement ce lancement
                            </label>
                        </div>
                    </div>

                    <!-- Formulaire de suppression -->
                    <form method="post" id="deleteForm" style="display: none;">
                        {% csrf_token %}
                    </form>
                </div>

                <!-- Sidebar droite -->
                <div class="col-lg-4">
                    <div class="action-buttons">
                        <!-- Actions -->
                        <div class="card info-card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i class="fas fa-tools me-2"></i>
                                    Actions
                                </h5>
                            </div>
                            <div class="card-body d-grid gap-2">
                                <button type="button" id="confirmDeleteBtn" class="btn btn-danger btn-lg" disabled>
                                    <i class="fas fa-trash"></i> Supprimer Définitivement
                                </button>
                                
                                <a href="{% url 'lancements:edit' lancement.pk %}" class="btn btn-warning">
                                    <i class="fas fa-edit"></i> Modifier plutôt
                                </a>
                                
                                <a href="{% url 'lancements:detail' lancement.pk %}" class="btn btn-outline-info">
                                    <i class="fas fa-eye"></i> Voir les détails
                                </a>
                                
                                <a href="{% url 'lancements:list' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left"></i> Retour à la liste
                                </a>
                            </div>
                        </div>

                        <!-- Informations complémentaires -->
                        <div class="card info-card">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i class="fas fa-question-circle me-2"></i>
                                    Aide
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-warning">
                                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Rappel Important</h6>
                                    <p class="mb-0 small">
                                        Une fois supprimé, ce lancement ne pourra plus être récupéré. 
                                        Assurez-vous d'avoir sauvegardé toutes les informations importantes.
                                    </p>
                                </div>
                                
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-phone me-2"></i>Besoin d'aide ?</h6>
                                    <p class="mb-0 small">
                                        En cas de doute, contactez votre responsable ou l'administrateur système avant de procéder à la suppression.
                                    </p>
                                </div>

                                <!-- Statistiques du lancement -->
                                <div class="mt-3">
                                    <h6>Récapitulatif</h6>
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="border-end">
                                                <strong class="text-info d-block">{{ lancement.get_poids_total|floatformat:1 }}kg</strong>
                                                <small class="text-muted">Poids Total</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <strong class="text-primary d-block">{{ lancement.date_lancement|timesince }}</strong>
                                            <small class="text-muted">Depuis création</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const confirmCheckbox = document.getElementById('confirmDelete');
    const deleteBtn = document.getElementById('confirmDeleteBtn');
    const deleteForm = document.getElementById('deleteForm');

    // Activer/désactiver le bouton de suppression selon la checkbox
    confirmCheckbox.addEventListener('change', function() {
        if (this.checked) {
            deleteBtn.disabled = false;
            deleteBtn.classList.remove('btn-outline-danger');
            deleteBtn.classList.add('btn-danger');
            deleteForm.style.display = 'block';
        } else {
            deleteBtn.disabled = true;
            deleteBtn.classList.remove('btn-danger');
            deleteBtn.classList.add('btn-outline-danger');
            deleteForm.style.display = 'none';
        }
    });

    // Gestion du clic sur le bouton de suppression
    deleteBtn.addEventListener('click', function() {
        if (confirmCheckbox.checked) {
            // Triple confirmation pour une action aussi critique
            const firstConfirm = confirm(
                `ATTENTION: Vous allez supprimer définitivement le lancement "${lancement.num_lanc}". Cette action est irréversible!\n\nÊtes-vous absolument certain de vouloir continuer?`
            );
            
            if (firstConfirm) {
                const secondConfirm = confirm(
                    `Dernière chance!\n\nLa suppression du lancement "${lancement.num_lanc}" entraînera la perte définitive de toutes les données associées.\n\nVoulez-vous vraiment procéder?`
                );
                
                if (secondConfirm) {
                    // Animation de suppression
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Suppression en cours...';
                    this.disabled = true;
                    
                    // Soumettre le formulaire après une courte pause pour l'animation
                    setTimeout(() => {
                        deleteForm.submit();
                    }, 1000);
                }
            }
        }
    });

    // Avertissement si l'utilisateur essaie de quitter la page
    let userConfirmedDelete = false;
    
    deleteForm.addEventListener('submit', function() {
        userConfirmedDelete = true;
    });
    
    window.addEventListener('beforeunload', function(e) {
        if (!userConfirmedDelete && confirmCheckbox.checked) {
            e.preventDefault();
            e.returnValue = 'Vous avez coché la case de confirmation mais n\'avez pas encore supprimé le lancement. Voulez-vous vraiment quitter cette page?';
        }
    });
});

// Variable JavaScript pour le template (utilisée dans les confirmations)
const lancement = {
    num_lanc: '{{ lancement.num_lanc|escapejs }}'
};
</script>
{% endblock %}