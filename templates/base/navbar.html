{% load static %}
{% load permission_tags %}

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <!-- Logo et nom de l'entreprise -->
        <a class="navbar-brand d-flex align-items-center" href="{% url 'core:dashboard' %}">
            <img src="{% static 'img/logo-aic.png' %}" alt="AIC Métallurgie" height="40" class="me-2">
            <span class="fw-bold">AIC Métallurgie</span>
        </a>
        
        <!-- Bouton pour mobile -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        
        <!-- Menu de navigation -->
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <!-- Dashboard -->
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'core:dashboard' %}">
                        <i class="fas fa-home"></i> Accueil
                    </a>
                </li>
                
                <!-- Gestion des données -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="donneesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-database"></i> Données de base
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="donneesDropdown">
                        {% has_permission 'collaborateurs' 'read' as can_view_collaborateurs %}
                        {% if can_view_collaborateurs %}
                        <li><a class="dropdown-item" href="{% url 'collaborateurs:list' %}">
                            <i class="fas fa-users"></i> Collaborateurs
                        </a></li>
                        {% endif %}
                        
                        {% has_permission 'ateliers' 'read' as can_view_ateliers %}
                        {% if can_view_ateliers %}
                        <li><a class="dropdown-item" href="{% url 'ateliers:list' %}">
                            <i class="fas fa-industry"></i> Ateliers
                        </a></li>
                        {% endif %}
                        
                        {% has_permission 'categories' 'read' as can_view_categories %}
                        {% if can_view_categories %}
                        <li><a class="dropdown-item" href="{% url 'ateliers:categorie_list' %}">
                            <i class="fas fa-tags"></i> Catégories
                        </a></li>
                        {% endif %}
                        
                        {% has_permission 'affaires' 'read' as can_view_affaires %}
                        {% if can_view_affaires %}
                        {% if can_view_collaborateurs or can_view_ateliers or can_view_categories %}
                        <li><hr class="dropdown-divider"></li>
                        {% endif %}
                        <li><a class="dropdown-item" href="{% url 'core:affaires_list' %}">
                            <i class="fas fa-briefcase"></i> Affaires
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                
                <!-- Lancements -->
                {% has_permission 'lancements' 'read' as can_view_lancements %}
                {% if can_view_lancements %}
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="lancementsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-rocket"></i> Lancements
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="lancementsDropdown">
                        <li><a class="dropdown-item" href="{% url 'lancements:list' %}">
                            <i class="fas fa-list"></i> Liste des lancements
                        </a></li>
                        
                        {% has_permission 'lancements' 'create' as can_create_lancement %}
                        {% if can_create_lancement %}
                        <li><a class="dropdown-item" href="{% url 'lancements:create' %}">
                            <i class="fas fa-plus"></i> Nouveau lancement
                        </a></li>
                        {% endif %}
                        
                        <li><a class="dropdown-item" href="{% url 'lancements:planning' %}">
                            <i class="fas fa-calendar"></i> Planning
                        </a></li>
                    </ul>
                </li>
                {% endif %}
                
                <!-- Reporting -->
                {% has_permission 'rapports' 'read' as can_view_rapports %}
                {% if can_view_rapports %}
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="reportingDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-chart-bar"></i> Reporting
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="reportingDropdown">
                        <li><a class="dropdown-item" href="{% url 'reporting:graphiques' %}">
                            <i class="fas fa-chart-line"></i> Tableaux de bord
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'reporting:rapports_list' %}">
                            <i class="fas fa-file-alt"></i> Rapports
                        </a></li>
                        
                        {% has_permission 'rapports' 'export' as can_export_rapports %}
                        {% if can_export_rapports %}
                        <li><a class="dropdown-item" href="{% url 'reporting:export' %}">
                            <i class="fas fa-download"></i> Export
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}
                
                <!-- Administration -->
                {% has_permission 'administration' 'read' as can_admin %}
                {% if can_admin %}
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-cog"></i> Administration
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="adminDropdown">
                        <li><a class="dropdown-item" href="{% url 'core:roles_list' %}">
                            <i class="fas fa-user-tag"></i> Gestion des rôles
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/admin/">
                            <i class="fas fa-tools"></i> Admin Django
                        </a></li>
                    </ul>
                </li>
                {% endif %}
            </ul>
            
            <!-- Menu utilisateur -->
            <ul class="navbar-nav">
                <!-- Notifications -->
                <li class="nav-item dropdown me-2">
                    <a class="nav-link position-relative" href="#" id="notificationsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-bell"></i>
                        {% if nb_notifications_non_lues > 0 %}
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notification-count">
                            {{ nb_notifications_non_lues }}
                        </span>
                        {% else %}
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none" id="notification-count">
                            0
                        </span>
                        {% endif %}
                    </a>
                    <div class="dropdown-menu dropdown-menu-end p-0 notification-dropdown" aria-labelledby="notificationsDropdown">
                        <!-- Header des notifications -->
                        <div class="dropdown-header d-flex justify-content-between align-items-center bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-bell me-1"></i>Notifications
                                <span class="badge bg-primary ms-1" id="notification-badge">{{ nb_notifications_non_lues|default:0 }}</span>
                            </h6>
                            <div class="dropdown-header-actions">
                                <button class="btn btn-sm btn-link p-0" id="mark-all-read-btn" title="Tout marquer comme lu">
                                    <i class="fas fa-check-double text-success"></i>
                                </button>
                                <a href="{% url 'core:notifications_list' %}" class="btn btn-sm btn-link p-0 ms-2" title="Voir toutes">
                                    <i class="fas fa-list text-primary"></i>
                                </a>
                            </div>
                        </div>
                        
                        <!-- Liste des notifications -->
                        <div id="notifications-container">
                            {% if notifications_non_lues %}
                                {% for notification in notifications_non_lues %}
                                <div class="notification-item border-bottom" data-notification-id="{{ notification.id }}">
                                    <a href="{% if notification.url_action %}{{ notification.url_action }}{% else %}#{% endif %}" 
                                       class="dropdown-item notification-link py-3"
                                       data-notification-id="{{ notification.id }}">
                                        <div class="d-flex align-items-start">
                                            <div class="notification-icon me-2">
                                                <i class="{{ notification.get_icon_class }}"></i>
                                            </div>
                                            <div class="notification-content flex-grow-1">
                                                <div class="notification-title fw-bold text-truncate">
                                                    {{ notification.titre }}
                                                </div>
                                                <div class="notification-message text-muted small">
                                                    {{ notification.message|truncatewords:10 }}
                                                </div>
                                                <div class="notification-time text-muted small">
                                                    <i class="fas fa-clock me-1"></i>Il y a {{ notification.get_time_ago }}
                                                </div>
                                            </div>
                                            <div class="notification-actions">
                                                <button class="btn btn-sm btn-link p-0 text-success mark-read-btn" 
                                                        data-notification-id="{{ notification.id }}"
                                                        title="Marquer comme lu">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="dropdown-item-text text-center py-4" id="no-notifications">
                                    <div class="text-muted">
                                        <i class="fas fa-bell-slash fa-2x mb-2"></i>
                                        <p class="mb-0">Aucune nouvelle notification</p>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Footer des notifications -->
                        <div class="dropdown-divider m-0"></div>
                        <div class="dropdown-item-text text-center">
                            <a href="{% url 'core:notifications_list' %}" class="btn btn-primary btn-sm">
                                <i class="fas fa-list me-1"></i>Voir toutes les notifications
                            </a>
                        </div>
                    </div>
                </li>
                
                <!-- Menu utilisateur -->
                {% if user.is_authenticated %}
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" 
                       href="#" 
                       id="userDropdown" 
                       role="button" 
                       data-bs-toggle="dropdown" 
                       aria-expanded="false">
                        <i class="fas fa-user-circle me-2"></i>
                        <div class="d-flex flex-column align-items-start">
                            <span class="fw-bold">{{ user.get_full_name|default:"Utilisateur" }}</span>
                            {% if user.user_role %}
                            <small class="text-light opacity-75" style="font-size: 0.75rem;">{{ user.user_role.name }}</small>
                            {% endif %}
                        </div>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li>
                            <a class="dropdown-item" href="{% url 'collaborateurs:profile' %}">
                                <i class="fas fa-user me-2"></i> Mon profil
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="{% url 'core:notifications_list' %}">
                                <i class="fas fa-bell me-2"></i> Mes notifications
                                {% if nb_notifications_non_lues > 0 %}
                                <span class="badge bg-danger ms-1">{{ nb_notifications_non_lues }}</span>
                                {% endif %}
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <div class="dropdown-item-text">
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    Connecté depuis {{ user.last_login|timesince }}
                                </small>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-danger" href="{% url 'collaborateurs:logout' %}">
                                <i class="fas fa-sign-out-alt me-2"></i> Déconnexion
                            </a>
                        </li>
                    </ul>
                </li>
                {% else %}
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'collaborateurs:login' %}">
                        <i class="fas fa-sign-in-alt"></i> Connexion
                    </a>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>
</nav>

<style>
.navbar-nav .nav-item.dropdown.me-2 {
    margin-right: 0 !important;
    margin-left: 0 !important;
}
.navbar-nav .nav-item a[href*="dashboard"] {
    padding: auto;
    margin-right: 0rem;
    gap: 0rem;

}
.navbar-nav.me-auto {
    margin-left: 4.5rem !important; /* Supprimer la marge gauche du menu */
    padding-left: 0;
}
.navbar .container-fluid {
    gap: -4rem; /* Supprime l'espace entre les éléments flex */
    padding-left: 0.5rem;
    padding-right: 0.5rem;
}
</style>
<!-- Pass Django variables to JavaScript safely through data attributes -->
<div id="django-data" 
     data-nb-notifications="{{ nb_notifications_non_lues|default:0 }}"
     data-mark-read-url-template="{% url 'core:notification_mark_read' notification_id=12345 %}"
     data-mark-all-read-url="{% url 'core:notifications_mark_all_read' %}"
     data-notifications-json-url="{% url 'core:notifications_json' %}"
     data-csrf-token="{{ csrf_token }}"
     style="display: none;">
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get Django data safely from data attributes
    var djangoDataElement = document.getElementById('django-data');
    var currentNotificationCount = parseInt(djangoDataElement.dataset.nbNotifications) || 0;
    var markReadUrlTemplate = djangoDataElement.dataset.markReadUrlTemplate.replace('12345', '__ID__');
    var markAllReadUrl = djangoDataElement.dataset.markAllReadUrl;
    var notificationsJsonUrl = djangoDataElement.dataset.notificationsJsonUrl;
    var csrfToken = djangoDataElement.dataset.csrfToken;
    
    // Variables globales pour les notifications
    var notificationCheckInterval;

    // Event delegation for notification clicks
    document.addEventListener('click', function(event) {
        // Handle notification link clicks
        if (event.target.closest('.notification-link')) {
            var link = event.target.closest('.notification-link');
            var notificationId = link.dataset.notificationId;
            if (notificationId) {
                marquerNotificationLue(parseInt(notificationId));
            }
        }
        
        // Handle mark as read button clicks
        if (event.target.closest('.mark-read-btn')) {
            event.preventDefault();
            event.stopPropagation();
            var button = event.target.closest('.mark-read-btn');
            var notificationId = button.dataset.notificationId;
            if (notificationId) {
                marquerNotificationLue(parseInt(notificationId));
            }
        }
        
        // Handle mark all read button
        if (event.target.closest('#mark-all-read-btn')) {
            event.preventDefault();
            event.stopPropagation();
            marquerToutesNotificationsLues();
        }
    });

    // Fonction pour marquer une notification comme lue
    function marquerNotificationLue(notificationId) {
        var markReadUrl = markReadUrlTemplate.replace('__ID__', notificationId);
        
        fetch(markReadUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                var notificationElement = document.querySelector('[data-notification-id="' + notificationId + '"]');
                if (notificationElement) {
                    notificationElement.style.transition = 'opacity 0.3s ease';
                    notificationElement.style.opacity = '0';
                    setTimeout(function() {
                        notificationElement.remove();
                        updateNotificationCount(data.nb_notifications_restantes);
                        
                        if (data.nb_notifications_restantes === 0) {
                            showNoNotificationsMessage();
                        }
                    }, 300);
                }
            } else {
                console.error('Erreur:', data.message);
            }
        })
        .catch(function(error) {
            console.error('Erreur réseau:', error);
        });
    }

    // Fonction pour marquer toutes les notifications comme lues
    function marquerToutesNotificationsLues() {
        fetch(markAllReadUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                var container = document.getElementById('notifications-container');
                container.innerHTML = '';
                
                updateNotificationCount(0);
                showNoNotificationsMessage();
                
                showNotificationToast('Toutes les notifications ont été marquées comme lues', 'success');
            } else {
                console.error('Erreur:', data.message);
            }
        })
        .catch(function(error) {
            console.error('Erreur réseau:', error);
        });
    }

    // Fonction pour mettre à jour le compteur de notifications
    function updateNotificationCount(count) {
        currentNotificationCount = count;
        var badge = document.getElementById('notification-count');
        var headerBadge = document.getElementById('notification-badge');
        
        if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('d-none');
            headerBadge.textContent = count;
        } else {
            badge.classList.add('d-none');
            headerBadge.textContent = '0';
        }
    }

    // Fonction pour afficher le message "aucune notification"
    function showNoNotificationsMessage() {
        var container = document.getElementById('notifications-container');
        container.innerHTML = '<div class="dropdown-item-text text-center py-4" id="no-notifications">' +
            '<div class="text-muted">' +
            '<i class="fas fa-bell-slash fa-2x mb-2"></i>' +
            '<p class="mb-0">Aucune nouvelle notification</p>' +
            '</div>' +
            '</div>';
    }

    // Fonction pour afficher un toast de notification
    function showNotificationToast(message, type) {
        type = type || 'info';
        
        var toastContainer = document.getElementById('toast-container') || createToastContainer();
        
        var toastId = 'toast-' + Date.now();
        var bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info';
        
        var toastHtml = '<div class="toast ' + bgClass + ' text-white" id="' + toastId + '" role="alert" aria-live="assertive" aria-atomic="true">' +
            '<div class="toast-header ' + bgClass + ' text-white border-0">' +
            '<i class="fas fa-bell me-2"></i>' +
            '<strong class="me-auto">Notification</strong>' +
            '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>' +
            '</div>' +
            '<div class="toast-body">' + escapeHtml(message) + '</div>' +
            '</div>';
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        var toastElement = document.getElementById(toastId);
        if (typeof bootstrap !== 'undefined') {
            var toast = new bootstrap.Toast(toastElement, {
                delay: 3000
            });
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', function() {
                this.remove();
            });
        }
    }

    // Fonction pour créer le conteneur de toasts
    function createToastContainer() {
        var container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
        return container;
    }

    // Fonction pour échapper le HTML
    function escapeHtml(text) {
        var map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    // Fonction pour vérifier les nouvelles notifications
    function checkForNewNotifications() {
        fetch(notificationsJsonUrl)
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success && data.count !== currentNotificationCount) {
                if (data.count > currentNotificationCount) {
                    var difference = data.count - currentNotificationCount;
                    showNotificationToast(difference + ' nouvelle(s) notification(s)', 'info');
                }
                
                updateNotificationCount(data.count);
                updateNotificationsList(data.notifications);
            }
        })
        .catch(function(error) {
            console.error('Erreur lors de la vérification des notifications:', error);
        });
    }

    // Fonction pour mettre à jour la liste des notifications
    function updateNotificationsList(notifications) {
        var container = document.getElementById('notifications-container');
        
        if (!notifications || notifications.length === 0) {
            showNoNotificationsMessage();
            return;
        }
        
        var html = '';
        for (var i = 0; i < notifications.length; i++) {
            var notification = notifications[i];
            var urlAction = notification.url_action || '#';
            var iconClass = notification.icon_class || 'fas fa-bell';
            var truncatedMessage = notification.message && notification.message.length > 50 ? 
                notification.message.substring(0, 50) + '...' : (notification.message || '');
            
            html += '<div class="notification-item border-bottom" data-notification-id="' + notification.id + '">' +
                '<a href="' + escapeHtml(urlAction) + '" class="dropdown-item notification-link py-3" data-notification-id="' + notification.id + '">' +
                '<div class="d-flex align-items-start">' +
                '<div class="notification-icon me-2"><i class="' + escapeHtml(iconClass) + '"></i></div>' +
                '<div class="notification-content flex-grow-1">' +
                '<div class="notification-title fw-bold text-truncate">' + escapeHtml(notification.titre || '') + '</div>' +
                '<div class="notification-message text-muted small">' + escapeHtml(truncatedMessage) + '</div>' +
                '<div class="notification-time text-muted small">' +
                '<i class="fas fa-clock me-1"></i>Il y a ' + escapeHtml(notification.time_ago || '') + '</div>' +
                '</div>' +
                '<div class="notification-actions">' +
                '<button class="btn btn-sm btn-link p-0 text-success mark-read-btn" ' +
                'data-notification-id="' + notification.id + '" title="Marquer comme lu">' +
                '<i class="fas fa-check"></i></button>' +
                '</div></div></a></div>';
        }
        
        container.innerHTML = html;
    }

    // Démarrer la vérification périodique des notifications
    notificationCheckInterval = setInterval(checkForNewNotifications, 30000);
    
    // Vérification immédiate après 1 seconde
    setTimeout(checkForNewNotifications, 1000);

    // Nettoyer l'interval quand on quitte la page
    window.addEventListener('beforeunload', function() {
        if (notificationCheckInterval) {
            clearInterval(notificationCheckInterval);
        }
    });
});
</script>